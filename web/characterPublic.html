<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, height=device-height, user-scalable=0"/>
    <link rel="icon" href="common/favicon.ico" type="image/x-icon">
    <title>MatesX</title>
    <link href="css/material-icons.css" rel="stylesheet">
    <style>
        #guide-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(50, 50, 50, 0.7);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        .guide-tooltip {
            background-color: white;
            border-radius: 16px;
            padding: 25px;
            max-width: 320px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            position: relative;
            text-align: center;
        }
        
        .guide-highlight {
            position: absolute;
            border-radius: 50%;
            box-shadow: 0 0 0 9999px rgba(255, 255, 255, 0.5), 0 0 15px 5px rgba(255, 60, 100, 0.3);
            z-index: 2001;
            pointer-events: none;
            transition: all 0.5s ease;
        }
        
        .guide-text {
            font-size: 16px;
            margin-bottom: 25px;
            color: #333;
            line-height: 1.5;
        }
        
        .guide-buttons {
            display: flex;
            justify-content: center;
            gap: 8px;
        }
        
        .guide-btn {
            background: linear-gradient(to bottom, #ff3c64, #d62e52);
            color: white;
            border: none;
            padding: 8px 10px;
            border-radius: 24px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            outline: none;
            min-width: 100px;
        }
        
        .guide-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 60, 100, 0.3);
        }
        
        .guide-btn.skip {
            background: #f0f0f0;
            color: #666;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
            /* background-color: #fafafa; */
            background-color: transparent; /* 改为透明 */
            color: #333;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* 标题栏样式 */
        .title-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 1) 0%, rgba(255, 255, 255, 0) 100%);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            backdrop-filter: blur(8px);
        }

        .title-bar.hidden {
            display: none;
        }

        .left-section, .right-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-button {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            border: none;
            outline: none;
            cursor: pointer;
        }

        .nav-button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .material-icons {
            color: #ff3c64;
            font-size: 20px;
        }

        /* 语音按钮状态 */
        .voice-off .material-icons {
            color: #999 !important;
        }

        /* 下拉选择器容器 */
        .selector-container {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        /* 自定义下拉选择器 */
        .custom-select {
            position: relative;
            min-width: 70px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 24px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
            height: 36px;
            padding: 0 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .custom-select:hover {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .custom-select .selected-option {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .custom-select .selected-option img {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            object-fit: cover;
        }

        .custom-select .dropdown {
            position: absolute;
            top: 40px;
            left: 0;
            width: 100%;
            background: white;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1001;
            display: none;
            padding: 8px 0;
        }

        .custom-select.active .dropdown {
            display: block;
        }

        .dropdown-option {
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s;
            font-size: 14px;
        }

        .dropdown-option:hover {
            background-color: #f8f8f8;
        }

        .dropdown-option img {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            object-fit: cover;
        }

        /* Toast提示 */
        #toast {
            position: fixed;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 14px 28px;
            border-radius: 30px;
            font-size: 16px;
            z-index: 2000;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        #toast.show {
            visibility: visible;
            opacity: 1;
        }

        /* 主内容区域 */
        .main-container {
            background-color: transparent; /* 改为透明 */
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            height: 100%;
        }

        /* 背景容器 */
        #background-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 1;
        }

        #background-video, #background-image {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            object-fit: cover;
        }

        #background-image {
            display: none;
        }

        /* 前景容器 */
        #foreground-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #canvas_video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* 加载状态 */
        #loadingSpinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            background: rgba(255, 255, 255, 0.9);
            padding: 20px 30px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 60, 100, 0.2);
            border-top: 5px solid #ff3c64;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #loadingSpinner strong {
            font-size: 18px;
            color: #333;
        }

        /* 开始提示 */
        #startMessage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 26px;
            font-weight: bold;
            color: #333;
            z-index: 15;
            cursor: pointer;
            background-color: rgba(255, 255, 255, 0.85);
            padding: 15px 30px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            text-align: center;
            backdrop-filter: blur(5px);
            max-width: 80%;
        }

        #startMessage:hover {
            background-color: rgba(255, 255, 255, 0.95);
            transform: translate(-50%, -50%) scale(1.05);
        }

        #canvas_gl {
            position: absolute;
            top: 100px;
            left: 100px;
            width: 180px;
            height: 180px;
            opacity: 0.001;
        }

        #screen {
            position: absolute;
            bottom: -1000;
            right: -1000;
            width: 1px;
            height: 1px;
        }
        #screen2 {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            border: none;
            z-index: 5;
            display: none; /* 初始隐藏 */
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .title-bar {
                padding: 0 10px;
            }

            #startMessage {
                font-size: 18px;
                padding: 10px 20px;
            }
        }
    </style>
</head>
<body>
    <div id="guide-overlay">
        <div class="guide-highlight"></div>
        <div class="guide-tooltip">
            <p class="guide-text" id="guide-text">欢迎使用MatesX！让我们开始探索功能</p>
            <div class="guide-buttons">
                <button class="guide-btn guide-next" id="guide-next">下一步</button>
                <button class="guide-btn guide-skip skip" id="guide-skip">跳过指引</button>
            </div>
        </div>
    </div>
    <div class="title-bar">
        <div class="left-section">
            <button class="nav-button back-btn" onclick="history.back()" title="返回">
                <i class="material-icons">arrow_back</i>
            </button>
        </div>
        <div class="right-section">
        <div class="selector-container" style="display: none;">
            <div class="custom-select" id="character-select" title="请选择人物">
                <div class="selected-option">
                    <i class="material-icons">person</i>
                    <img id="selected-character-thumb" alt="角色" style="display:none;">
                </div>
                <i class="material-icons">arrow_drop_down</i>
                <div class="dropdown" id="character-dropdown"></div>
            </div>
            <div class="custom-select" id="background-select" title="请在'我的'页面的背景设置中上传背景">
                <div class="selected-option">
                    <i class="material-icons">image</i>
                    <img id="selected-bg-thumb" alt="背景" style="display:none;">
                </div>
                <i class="material-icons">arrow_drop_down</i>
                <div class="dropdown" id="background-dropdown"></div>
            </div>
            <button class="nav-button" id="text-toggle" title="显示聊天内容">
                <i class="material-icons">chat</i>
            </button>
            <button class="nav-button" id="voice-toggle" title="语音实时打断">
                <i class="material-icons">mic</i>
            </button>
            <button class="nav-button settings-btn">
                <i class="material-icons">settings</i>
            </button>
        </div>
        </div>
    </div>

    <!-- 主内容区域 -->
    <div class="main-container">
        <!-- 背景容器 -->
        <div id="background-container">
            <video id="background-video" autoplay loop muted></video>
            <img id="background-image" src="" alt="背景图片">
        </div>

        <!-- 前景容器 -->
        <div id="foreground-container">
            <canvas id="canvas_video"></canvas>
        </div>
        <!-- 加载状态 -->
        <div id="loadingSpinner">
            <div class="spinner"></div>
            <strong>MatesX: 正在加载中...</strong>
        </div>
        <!-- 开始提示 -->
        <!-- <div id="startMessage">请点击屏幕开始</div> -->
         <div id="startMessage" style="display: none;">请点击屏幕开始</div>
    </div>

    <!-- Toast提示 -->
    <div id="toast">
        <i class="material-icons" id="toast-icon">info</i>
        <span id="toast-text">语音打断功能已开启</span>
    </div>

    <canvas id="canvas_gl" width="180" height="180"></canvas>
    <div id="screen"></div>
    <iframe id="screen2" src="dialogRealtime.html" frameborder="0"></iframe>
    <script src="js/pako.min.js"></script>
    <script src="js/database.js"></script>
    <script src="js/embedding.js"></script>
    <script src="js/DHLiveMini2.js"></script>
    <script src="js/MiniLive.js"></script>
    <script src="js/MiniMateLoader_public.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {

            // 检查是否已经显示过指引
            // localStorage.setItem('guideShown', 0);
            const guideShown = localStorage.getItem('guideShown', 0);
            if (guideShown < 1) {
                // 延迟显示指引，确保元素已渲染
                setTimeout(showGuide, 1200);
            }
            
            // 显示指引
            function showGuide() {
                const guideOverlay = document.getElementById('guide-overlay');
                const guideText = document.getElementById('guide-text');
                const guideNext = document.getElementById('guide-next');
                const guideSkip = document.getElementById('guide-skip');
                const guideHighlight = document.querySelector('.guide-highlight');
                
                // 确保selector-container可见
                document.querySelector('.selector-container').style.display = 'flex';
                
                // 指引步骤
                const steps = [
                    {
                        element: document.getElementById('character-select'),
                        text: '这是角色选择器，点击可以切换不同虚拟角色',
                        position: 'bottom'
                    },
                    {
                        element: document.getElementById('background-select'),
                        text: '这是背景选择器，可以更换各种场景背景及添加绿幕',
                        position: 'bottom'
                    },
                    {
                        element: document.getElementById('voice-toggle'),
                        text: '这是语音按钮，开启后可语音打断AI对话,若无效请关闭',
                        position: 'bottom'
                    },
                    {
                        element: document.querySelector('.settings-btn'),
                        text: '这是设置按钮，可调整系统参数和偏好设置',
                        position: 'bottom'
                    }
                ];
                
                let currentStep = 0;
                
                // 显示当前步骤
                function showStep(stepIndex) {
                    if (stepIndex >= steps.length) {
                        // 完成指引
                        localStorage.setItem('guideShown', 1);
                        guideOverlay.style.display = 'none';
                        return;
                    }
                    
                    const step = steps[stepIndex];
                    const element = step.element;
                    
                    // 计算元素位置
                    const rect = element.getBoundingClientRect();
                    const centerX = rect.left + rect.width / 2;
                    const centerY = rect.top + rect.height / 2;
                    
                    // 更新高亮圈位置和大小
                    const highlightSize = Math.max(rect.width, rect.height) * 1.8;
                    guideHighlight.style.width = highlightSize + 'px';
                    guideHighlight.style.height = highlightSize + 'px';
                    guideHighlight.style.left = (centerX - highlightSize / 2) + 'px';
                    guideHighlight.style.top = (centerY - highlightSize / 2) + 'px';
                    
                    // 更新提示文本
                    guideText.textContent = step.text;
                    
                    // 更新按钮状态
                    guideNext.textContent = stepIndex === steps.length - 1 ? '完成' : '下一步';
                    
                    // 显示指引层
                    guideOverlay.style.display = 'flex';
                    currentStep = stepIndex;
                }
                
                // 事件监听
                guideNext.addEventListener('click', function() {
                    showStep(currentStep + 1);
                });
                
                guideSkip.addEventListener('click', function() {
                    localStorage.setItem('guideShown', 1);
                    guideOverlay.style.display = 'none';
                });
                
                // 开始第一步
                showStep(0);
            }
        });
            const voiceToggle = document.getElementById('voice-toggle');
            const textToggle = document.getElementById('text-toggle');
            const toast = document.getElementById('toast');
            const toastText = document.getElementById('toast-text');
            const toastIcon = document.getElementById('toast-icon');
            // 从localStorage加载状态
            let voiceDisturbEnabled = localStorage.getItem('voiceDisturbEnabled') === 'true';
            if (localStorage.getItem('voiceDisturbEnabled') === null) {
                voiceDisturbEnabled = true; // 默认开启
            }
            let chatHistoryShowed = localStorage.getItem('chatHistoryShowed') === 'true';
            if (localStorage.getItem('chatHistoryShowed') === null) {
                chatHistoryShowed = true; // 默认开启
            }
            textToggle.addEventListener('click', function() {
                chatHistoryShowed = !chatHistoryShowed;
                localStorage.setItem('chatHistoryShowed', chatHistoryShowed);
            });
            
            // 初始设置
            updateVoiceButton();
            
            // 点击切换状态
            voiceToggle.addEventListener('click', function() {
                voiceDisturbEnabled = !voiceDisturbEnabled;
                
                // 添加动画效果
                voiceToggle.classList.add('pulse');
                setTimeout(() => {
                    voiceToggle.classList.remove('pulse');
                }, 500);
                
                updateVoiceButton();
                showToast(voiceDisturbEnabled ? '语音打断功能已开启' : '语音打断功能已关闭');
                
                // 保存状态
                localStorage.setItem('voiceDisturbEnabled', voiceDisturbEnabled);
            });
            
            // 更新按钮状态
            function updateVoiceButton() {
                const icon = voiceToggle.querySelector('.material-icons');
                if (voiceDisturbEnabled) {
                    voiceToggle.classList.remove('voice-off');
                    icon.textContent = 'mic';
                    icon.style.color = '#ff3c64';
                } else {
                    voiceToggle.classList.add('voice-off');
                    icon.textContent = 'mic_off';
                    icon.style.color = '#999';
                }
            }
            
            // 显示Toast提示
            function showToast(message) {
                toastText.textContent = message;
                toastIcon.textContent = voiceDisturbEnabled ? 'mic' : 'mic_off';
                toast.classList.add('show');
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }
    </script>
</body>
</html>